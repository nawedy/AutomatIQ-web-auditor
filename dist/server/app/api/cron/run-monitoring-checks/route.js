(()=>{var e={};e.id=631,e.ids=[631],e.modules={278:(e,t,r)=>{"use strict";function i(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}r.d(t,{w:()=>i})},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},10945:(e,t,r)=>{var i=r(94339);t.operation=function(e){return new i(t.timeouts(e),{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<t.retries;o++)i.push(this.createTimeout(o,t));return e&&e.forever&&!i.length&&i.push(this.createTimeout(o,t)),i.sort(function(e,t){return e-t}),i},t.createTimeout=function(e,t){var r=Math.round((t.randomize?Math.random()+1:1)*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,r,i){if(r instanceof Array&&(i=r,r=null),!i)for(var o in i=[],e)"function"==typeof e[o]&&i.push(o);for(var s=0;s<i.length;s++){var n=i[s],a=e[n];e[n]=(function(i){var o=t.operation(r),s=Array.prototype.slice.call(arguments,1),n=s.pop();s.push(function(e){o.retry(e)||(e&&(arguments[0]=o.mainError()),n.apply(this,arguments))}),o.attempt(function(){i.apply(e,s)})}).bind(e,a),e[n].options=r}}},14133:(e,t,r)=>{"use strict";r.d(t,{P:()=>s});var i=r(90672),o=r(278);function s(e,t){let r=(0,i.a)(e);if(isNaN(t))return(0,o.w)(e,NaN);if(!t)return r;let s=r.getDate(),n=(0,o.w)(e,r.getTime());return(n.setMonth(r.getMonth()+t+1,0),s>=n.getDate())?n:(r.setFullYear(n.getFullYear(),n.getMonth(),s),r)}},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34631:e=>{"use strict";e.exports=require("tls")},37366:e=>{"use strict";e.exports=require("dns")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52438:(e,t,r)=>{"use strict";let i=r(82971),o=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}let n=(e,t,r)=>{let i=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=i,e},a=e=>o.includes(e),u=(e,t)=>new Promise((r,o)=>{t={onFailedAttempt:()=>{},retries:10,...t};let u=i.operation(t);u.attempt(async i=>{try{r(await e(i))}catch(e){if(!(e instanceof Error))return void o(TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)u.stop(),o(e.originalError);else if(e instanceof TypeError&&!a(e.message))u.stop(),o(e);else{n(e,i,t);try{await t.onFailedAttempt(e)}catch(e){o(e);return}u.retry(e)||o(u.mainError())}}})});e.exports=u,e.exports.default=u,e.exports.AbortError=s},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},59217:(e,t,r)=>{"use strict";r.d(t,{f:()=>s});var i=r(90672),o=r(278);function s(e,t){let r=(0,i.a)(e);return isNaN(t)?(0,o.w)(e,NaN):(t&&r.setDate(r.getDate()+t),r)}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66524:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>D,routeModule:()=>S,serverHooks:()=>q,workAsyncStorage:()=>R,workUnitAsyncStorage:()=>N});var i={};r.r(i),r.d(i,{GET:()=>E,POST:()=>v});var o=r(96559),s=r(48088),n=r(37719),a=r(32190),u=r(96330),c=r(59217),h=r(87579),m=r(14133),p=r(52438),l=r.n(p);class f{constructor(e){this.context=e}formatMessage(e,t,...r){let i=new Date().toISOString();return[`[${i}] [${e}] [${this.context}]`,t,...r]}info(e,...t){console.info(...this.formatMessage("INFO",e,...t))}warn(e,...t){console.warn(...this.formatMessage("WARN",e,...t))}error(e,...t){console.error(...this.formatMessage("ERROR",e,...t))}debug(e,...t){}createChildLogger(e){return new f(`${this.context}:${e}`)}}var d=r(51672);let g=new u.PrismaClient,w=new f("monitoring-service-adapter"),y={retries:3,minTimeout:1e3,maxTimeout:3e3,onRetry:(e,t)=>{w.warn(`Retry attempt ${t} due to error:`,e)}},_=[];class x{constructor(e){this.monitoringService=new d.GL,this.storageType=e?.storage||"in-memory"}async runScheduledChecks(){try{let e=await l()(async()=>await g.website.findMany({include:{auditSchedule:!0}}),y);w.info(`Found ${e.length} websites`);let t=0;for(let r of e)try{if(r.auditSchedule?.enabled){let e=_.filter(e=>e.websiteId===r.id).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime())[0],i=r.auditSchedule.frequency;if(!e||this.isCheckDue(i,e.timestamp)){w.info(`Running check for website ${r.id} (${r.name})`);let e={websiteId:r.id,timestamp:new Date,status:"RUNNING"};_.push(e);try{await this.monitoringService.runScheduledChecks(),e.status="COMPLETED",e.results={success:!0},t++,w.info(`Completed monitoring check for website ${r.id}`)}catch(t){e.status="FAILED",e.results={error:t.message||"Unknown error"},w.error(`Failed monitoring check for website ${r.id}:`,t)}}else w.debug(`Skipping check for website ${r.id}, not due yet`)}}catch(e){w.error(`Error processing website ${r.id}:`,e)}return t}catch(e){return w.error("Error running scheduled checks:",e),0}}isCheckDue(e,t){let r;if(!t)return!0;let i=new Date;switch(e){case"DAILY":r=(0,c.f)(t,1);break;case"WEEKLY":default:r=(0,h.J)(t,1);break;case"BIWEEKLY":r=(0,h.J)(t,2);break;case"MONTHLY":r=(0,m.P)(t,1);break;case"QUARTERLY":r=(0,m.P)(t,3)}return i>=r}async getWebsitesDueForCheck(){try{let e=await l()(async()=>await g.website.findMany({where:{auditSchedule:{enabled:!0}},include:{auditSchedule:!0}}),y),t=[];for(let r of e){let e=_.filter(e=>e.websiteId===r.id).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime())[0],i=r.auditSchedule?.frequency||"WEEKLY";(!e||this.isCheckDue(i,e.timestamp))&&t.push(r.id)}return t}catch(e){return w.error("Error getting websites due for check:",e),[]}}}let T=new f("cron-monitoring-checks"),b=new u.PrismaClient;function k(e){let t=e.headers.get("authorization"),r=t?.startsWith("Bearer ")?t.substring(7):t;return!!r&&r===process.env.CRON_SECRET||(T.error("Unauthorized cron job attempt with invalid secret"),!1)}async function v(e){try{let t=e.headers.get("authorization");t?.startsWith("Bearer ")&&t.substring(7);try{if(!k(e))return T.warn("Unauthorized attempt to run monitoring checks"),a.NextResponse.json({error:"Unauthorized"},{status:401});T.info("Running scheduled monitoring checks");let t=new x({storage:"in-memory"}),r=await t.runScheduledChecks();return T.info(`Completed monitoring checks for ${r} websites`),a.NextResponse.json({success:!0,checkedCount:r,timestamp:new Date().toISOString(),message:`Successfully ran monitoring checks for ${r} websites`})}catch(e){return T.error("Error running scheduled monitoring checks:",e),a.NextResponse.json({error:"Failed to run scheduled monitoring checks",message:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}catch(e){return T.error("Error running scheduled monitoring checks:",e),a.NextResponse.json({error:"Failed to run scheduled monitoring checks",message:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}async function E(e){try{let t=e.headers.get("authorization");t?.startsWith("Bearer ")&&t.substring(7);try{if(!k(e))return T.warn("Unauthorized attempt to access monitoring health check"),a.NextResponse.json({error:"Unauthorized"},{status:401});T.info("Processing monitoring health check");let t=await b.auditSchedule.count({where:{enabled:!0}}),r=new x,i=(await r.getWebsitesDueForCheck()).length;return T.info(`Found ${t} enabled monitoring configs, ${i} due for checks`),a.NextResponse.json({status:"healthy",enabledConfigsCount:t,dueWebsitesCount:i,timestamp:new Date().toISOString(),message:"Monitoring cron job is properly configured"})}catch(e){return T.error("Error in monitoring cron health check:",e),a.NextResponse.json({error:"Failed to perform health check",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}catch(e){return T.error("Error in monitoring cron health check:",e),a.NextResponse.json({error:"Failed to perform health check",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let S=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/cron/run-monitoring-checks/route",pathname:"/api/cron/run-monitoring-checks",filename:"route",bundlePath:"app/api/cron/run-monitoring-checks/route"},resolvedPagePath:"/Users/drgn003/AutomatIQ/AI-website-auditor/app/api/cron/run-monitoring-checks/route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:R,workUnitAsyncStorage:N,serverHooks:q}=S;function D(){return(0,n.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:N})}},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},82971:(e,t,r)=>{e.exports=r(10945)},87579:(e,t,r)=>{"use strict";r.d(t,{J:()=>o});var i=r(59217);function o(e,t){return(0,i.f)(e,7*t)}},90672:(e,t,r)=>{"use strict";function i(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}r.d(t,{a:()=>i})},91645:e=>{"use strict";e.exports=require("net")},94339:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r)if(!this._cachedTimeouts)return!1;else this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,i=0;i<this._errors.length;i++){var o=this._errors[i],s=o.message,n=(e[s]||0)+1;e[s]=n,n>=r&&(t=o,r=n)}return t}},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[4243,580,9526,8420,2729,1672],()=>r(66524));module.exports=i})();