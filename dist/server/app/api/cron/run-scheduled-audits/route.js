"use strict";(()=>{var e={};e.id=5151,e.ids=[5151],e.modules={643:e=>{e.exports=require("node:perf_hooks")},2321:e=>{e.exports=require("@axe-core/puppeteer")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{e.exports=require("node:buffer")},5376:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>l,POST:()=>c});var i=r(32190),a=r(96330),u=r(32964),d=r(43254),n=r(28744),o=e([u]);u=(o.then?(await o)():o)[0];let c=async e=>{try{let t=e.headers.get("authorization"),r=t?.startsWith("Bearer ")?t.substring(7):t;if(!r||r!==process.env.CRON_SECRET)return console.error("Unauthorized cron job attempt with invalid secret"),i.NextResponse.json({error:"Unauthorized access"},{status:401});let s=new a.PrismaClient,d=new u.A(s);console.log(`[${(0,n.GP)(new Date,"yyyy-MM-dd HH:mm:ss")}] Starting scheduled audits processing`),await d.processScheduledAudits();let o=await s.$transaction(async e=>{let t=await e.auditSchedule.count({where:{enabled:!0}}),r=await e.audit.count({where:{type:"SCHEDULED",createdAt:{gte:new Date(new Date().setHours(0,0,0,0))}}}),s=await e.audit.count({where:{status:{in:["QUEUED","RUNNING"]},type:"SCHEDULED"}});return{totalScheduled:t,processedToday:r,pendingAudits:s}});return await s.$disconnect(),i.NextResponse.json({success:!0,message:"Scheduled audits processed successfully",timestamp:new Date().toISOString(),stats:o})}catch(e){return console.error("Error processing scheduled audits:",e),i.NextResponse.json({error:"Failed to process scheduled audits",message:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}},l=(0,d.ru)(async(e,t,r)=>{if("ADMIN"!==r.role)return i.NextResponse.json({error:"Unauthorized: Admin access required"},{status:403});try{let e=new a.PrismaClient,t=await e.$transaction(async e=>{let t=await e.website.count(),r=await e.website.count({where:{auditScheduleEnabled:!0}}),s=await e.audit.count({where:{type:"SCHEDULED"}}),i=await e.audit.count({where:{type:"SCHEDULED",status:"COMPLETED"}}),a=await e.audit.count({where:{type:"SCHEDULED",status:"FAILED"}}),u=await e.website.findFirst({where:{auditScheduleEnabled:!0},orderBy:{nextScheduledAuditAt:"asc"},select:{id:!0,name:!0,url:!0,nextScheduledAuditAt:!0,auditSchedule:!0}});return{totalWebsites:t,scheduledWebsites:r,scheduledAudits:s,completedAudits:i,failedAudits:a,nextScheduled:u,systemTime:new Date().toISOString()}});return await e.$disconnect(),i.NextResponse.json({success:!0,stats:t})}catch(e){return console.error("Error fetching scheduled audits status:",e),i.NextResponse.json({error:"Failed to fetch scheduled audits status",message:e instanceof Error?e.message:"Unknown error"},{status:500})}});s()}catch(e){s(e)}})},5486:e=>{e.exports=require("bcrypt")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{e.exports=require("querystring")},12412:e=>{e.exports=require("assert")},16141:e=>{e.exports=require("node:zlib")},16698:e=>{e.exports=require("node:async_hooks")},21820:e=>{e.exports=require("os")},22316:e=>{e.exports=require("lighthouse")},27910:e=>{e.exports=require("stream")},28354:e=>{e.exports=require("util")},29021:e=>{e.exports=require("fs")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32467:e=>{e.exports=require("node:http2")},32964:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{A:()=>d});var i=r(36600),a=r(56941),u=e([i]);i=(u.then?(await u)():u)[0];class d{constructor(e){this.prisma=e,this.notificationService=new a.J(e)}async processScheduledAudits(){try{let e=new Date,t=await this.prisma.website.findMany({where:{auditScheduleEnabled:!0,nextScheduledAuditAt:{lte:e}},include:{auditSchedule:!0,user:!0}});for(let e of(console.log(`Found ${t.length} websites due for scheduled audits`),t))await this.runScheduledAudit(e)}catch(e){console.error("Error processing scheduled audits:",e)}}async runScheduledAudit(e){try{let{id:t,url:r,userId:s,auditSchedule:a}=e,u=a?.frequency||"WEEKLY",d=a?.categories||["SEO","PERFORMANCE","ACCESSIBILITY","SECURITY","MOBILE","CONTENT"];console.log(`Running scheduled audit for website ${t} (${r}) with frequency ${u}`);let n=await this.prisma.audit.create({data:{websiteId:t,userId:s,type:"SCHEDULED",status:"QUEUED",categories:d,url:r}}),o=new i.K(this.prisma),c=await o.runAudit(n.id,r,d),l=await this.prisma.audit.findFirst({where:{websiteId:t,id:{not:n.id}},orderBy:{createdAt:"desc"}});await this.notificationService.createAuditNotifications(n.id,t,s,l?.id||null,c),await this.updateNextScheduledAuditTime(e),console.log(`Completed scheduled audit for website ${t}`)}catch(t){console.error(`Error running scheduled audit for website ${e.id}:`,t),await this.updateNextScheduledAuditTime(e)}}async updateNextScheduledAuditTime(e){let t,r=new Date;switch(e.auditSchedule?.frequency||"WEEKLY"){case"DAILY":t=new Date(r.getTime()+864e5);break;case"WEEKLY":default:t=new Date(r.getTime()+6048e5);break;case"BIWEEKLY":t=new Date(r.getTime()+12096e5);break;case"MONTHLY":(t=new Date(r)).setDate(t.getDate()+30);break;case"QUARTERLY":(t=new Date(r)).setDate(t.getDate()+90)}await this.prisma.website.update({where:{id:e.id},data:{lastScheduledAuditAt:r,nextScheduledAuditAt:t}})}async enableScheduledAudits(e,t="WEEKLY",r=["SEO","PERFORMANCE","ACCESSIBILITY","SECURITY","MOBILE","CONTENT"]){let s,i=new Date;(s=new Date(i)).setDate(i.getDate()+1),s.setHours(3,0,0,0),await this.prisma.website.update({where:{id:e},data:{auditScheduleEnabled:!0,nextScheduledAuditAt:s,auditSchedule:{upsert:{create:{frequency:t,categories:r,dayOfWeek:"WEEKLY"===t||"BIWEEKLY"===t?1:null,dayOfMonth:"MONTHLY"===t||"QUARTERLY"===t?1:null},update:{frequency:t,categories:r,dayOfWeek:"WEEKLY"===t||"BIWEEKLY"===t?1:null,dayOfMonth:"MONTHLY"===t||"QUARTERLY"===t?1:null}}}}})}async disableScheduledAudits(e){await this.prisma.website.update({where:{id:e},data:{auditScheduleEnabled:!1,nextScheduledAuditAt:null}})}async updateAuditSchedule(e,t,r,s,i){"WEEKLY"!==t&&"BIWEEKLY"!==t||s||(s=1),"MONTHLY"!==t&&"QUARTERLY"!==t||i||(i=1),await this.prisma.website.update({where:{id:e},data:{auditSchedule:{upsert:{create:{frequency:t,categories:r,dayOfWeek:s,dayOfMonth:i},update:{frequency:t,categories:r,dayOfWeek:s,dayOfMonth:i}}}}});let a=await this.prisma.website.findUnique({where:{id:e},include:{auditSchedule:!0}});a&&await this.updateNextScheduledAuditTime(a)}async getAuditSchedule(e){let t=await this.prisma.website.findUnique({where:{id:e},include:{auditSchedule:!0}});if(!t)throw Error(`Website with ID ${e} not found`);return{enabled:t.auditScheduleEnabled,schedule:t.auditSchedule,lastScheduledAuditAt:t.lastScheduledAuditAt,nextScheduledAuditAt:t.nextScheduledAuditAt}}async getScheduledAuditHistory(e,t=1,r=10){let[s,i]=await Promise.all([this.prisma.audit.findMany({where:{websiteId:e,type:"SCHEDULED"},orderBy:{createdAt:"desc"},skip:(t-1)*r,take:r,select:{id:!0,createdAt:!0,completedAt:!0,status:!0,overallScore:!0,seoScore:!0,performanceScore:!0,accessibilityScore:!0,securityScore:!0,mobileScore:!0,contentScore:!0}}),this.prisma.audit.count({where:{websiteId:e,type:"SCHEDULED"}})]);return{audits:s,total:i}}}s()}catch(e){s(e)}})},33873:e=>{e.exports=require("path")},34589:e=>{e.exports=require("node:assert")},34631:e=>{e.exports=require("tls")},37067:e=>{e.exports=require("node:http")},37366:e=>{e.exports=require("dns")},37540:e=>{e.exports=require("node:console")},40610:e=>{e.exports=require("node:dns")},41204:e=>{e.exports=require("string_decoder")},41692:e=>{e.exports=require("node:tls")},41792:e=>{e.exports=require("node:querystring")},43254:(e,t,r)=>{r.d(t,{ru:()=>d});var s=r(7462),i=r(19854),a=r(86753),u=r(32190);function d(e){return async(t,r)=>{try{let d=await (0,i.getServerSession)(a.N);if(!d?.user?.email)return u.NextResponse.json({error:"Unauthorized"},{status:401});let n=await s.zR.user.findUnique({where:{email:d.user.email},select:{id:!0,email:!0}});if(!n)return u.NextResponse.json({error:"User not found"},{status:404});return await (0,s.Gr)(n.id),e(t,r,n)}catch(e){return console.error("Authentication error:",e),u.NextResponse.json({error:"Authentication failed"},{status:500})}}}},44056:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>o,routeModule:()=>c,serverHooks:()=>h,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>p});var i=r(96559),a=r(48088),u=r(37719),d=r(5376),n=e([d]);d=(n.then?(await n)():n)[0];let c=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/run-scheduled-audits/route",pathname:"/api/cron/run-scheduled-audits",filename:"route",bundlePath:"app/api/cron/run-scheduled-audits/route"},resolvedPagePath:"/Users/drgn003/AutomatIQ/AI-website-auditor/app/api/cron/run-scheduled-audits/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:l,workUnitAsyncStorage:p,serverHooks:h}=c;function o(){return(0,u.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:p})}s()}catch(e){s(e)}})},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46906:e=>{e.exports=require("resemblejs")},53053:e=>{e.exports=require("node:diagnostics_channel")},55511:e=>{e.exports=require("crypto")},55591:e=>{e.exports=require("https")},57075:e=>{e.exports=require("node:stream")},57975:e=>{e.exports=require("node:util")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73136:e=>{e.exports=require("node:url")},73429:e=>{e.exports=require("node:util/types")},74075:e=>{e.exports=require("zlib")},75919:e=>{e.exports=require("node:worker_threads")},77030:e=>{e.exports=require("node:net")},77598:e=>{e.exports=require("node:crypto")},78474:e=>{e.exports=require("node:events")},79428:e=>{e.exports=require("buffer")},79551:e=>{e.exports=require("url")},79646:e=>{e.exports=require("child_process")},81630:e=>{e.exports=require("http")},83636:e=>{e.exports=import("puppeteer")},83997:e=>{e.exports=require("tty")},86753:(e,t,r)=>{r.d(t,{N:()=>c});var s=r(16467),i=r(13581),a=r(36344),u=r(65752),d=r(96330),n=r(5486);r(19854);let o=new d.PrismaClient,c={adapter:(0,s.y)(o),session:{strategy:"jwt"},pages:{signIn:"/auth/login",signOut:"/auth/logout",error:"/auth/error"},providers:[(0,i.A)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await o.user.findUnique({where:{email:e.email}});return t&&t.password&&await (0,n.compare)(e.password,t.password)?{id:t.id,email:t.email,name:t.name,image:t.image}:null}}),(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||""}),(0,u.A)({clientId:process.env.GITHUB_CLIENT_ID||"",clientSecret:process.env.GITHUB_CLIENT_SECRET||""})],callbacks:{session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.name=t.name,e.user.email=t.email,e.user.image=t.picture),e),jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e)}}},91645:e=>{e.exports=require("net")},94735:e=>{e.exports=require("events")},96330:e=>{e.exports=require("@prisma/client")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,580,9854,8909,9526,3810,2256,8744,2729,9061],()=>r(44056));module.exports=s})();