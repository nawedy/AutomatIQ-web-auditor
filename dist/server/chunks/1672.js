"use strict";exports.id=1672,exports.ids=[1672],exports.modules={51672:(t,e,r)=>{r.d(e,{GL:()=>f});var a=r(96330),i=r(56941);let n=r(35943).Q.fromEnv(),o={ALERTS:60,ALERTS_COUNT:60,CONFIG:300},s={ALERTS:"monitoring:alerts:",ALERTS_COUNT:"monitoring:alerts:count:",CONFIG:"monitoring:config:"};class c{static async getAlerts(t,e){try{let r=`${s.ALERTS}${t}:${e.limit}:${e.offset}:${e.unreadOnly}`;return await n.get(r)}catch(t){return console.error("Error getting alerts from cache:",t),null}}static async setAlerts(t,e,r){try{let a=`${s.ALERTS}${t}:${r.limit}:${r.offset}:${r.unreadOnly}`;await n.set(a,e,{ex:o.ALERTS})}catch(t){console.error("Error setting alerts in cache:",t)}}static async getAlertsCount(t,e){try{let r=`${s.ALERTS_COUNT}${t}:${e}`;return await n.get(r)}catch(t){return console.error("Error getting alerts count from cache:",t),null}}static async setAlertsCount(t,e,r){try{let a=`${s.ALERTS_COUNT}${t}:${r}`;await n.set(a,e,{ex:o.ALERTS_COUNT})}catch(t){console.error("Error setting alerts count in cache:",t)}}static async getConfig(t){try{let e=`${s.CONFIG}${t}`;return await n.get(e)}catch(t){return console.error("Error getting config from cache:",t),null}}static async setConfig(t,e){try{let r=`${s.CONFIG}${t}`;await n.set(r,e,{ex:o.CONFIG})}catch(t){console.error("Error setting config in cache:",t)}}static async invalidateWebsiteCache(t){try{let e=await n.keys(`*${t}*`);e.length>0&&await n.del(...e)}catch(t){console.error("Error invalidating website cache:",t)}}static async invalidateAlertsCache(t){try{let e=await n.keys(`${s.ALERTS}${t}*`),r=await n.keys(`${s.ALERTS_COUNT}${t}*`),a=[...e,...r];a.length>0&&await n.del(...a)}catch(t){console.error("Error invalidating alerts cache:",t)}}}var l=r(23870),g=r(52438),d=r.n(g),h=r(59217),u=r(87579),w=r(14133);let y=new a.PrismaClient,m={retries:3,onFailedAttempt:t=>{console.error(`Database operation failed (attempt ${t.attemptNumber||0}/4):`,t.message)}};class f{constructor(t){this.prisma=t||y,this.notificationService=new i.J(this.prisma),this.logger=console}async checkWebsiteMetrics(t){try{let e=await this.getMonitoringConfig(t);if(!e||!e.enabled)return[];let r=await d()(async()=>await y.audit.findFirst({where:{websiteId:t,status:"COMPLETED"},orderBy:{completedAt:"desc"},include:{summary:!0}}),m);if(!r||!r.summary)return[];let a=await d()(async()=>await y.audit.findFirst({where:{websiteId:t,status:"COMPLETED",completedAt:{lt:r.completedAt}},orderBy:{completedAt:"desc"},include:{summary:!0}}),m),i=[];for(let n of e.metrics){let o=r.summary[n];if(null!=o){if(a&&a.summary){let r=a.summary[n];if(null!=r){let a=o-r,s=a/r*100;a<0&&Math.abs(s)>=e.alertThreshold&&i.push({websiteId:t,type:"SCORE_DROP",severity:this.getSeverityForScoreDrop(Math.abs(s)),message:`${n} dropped by ${Math.abs(s).toFixed(1)}% (from ${r} to ${o})`,metric:n,threshold:e.alertThreshold,value:s,timestamp:new Date})}}o<50&&i.push({websiteId:t,type:"LOW_SCORE",severity:this.getSeverityForLowScore(o),message:`${n} is critically low at ${o}`,metric:n,value:o,timestamp:new Date})}}if(i.length>0){for(let e of i)await this.createAlert(t,e);e.emailNotifications&&await this.notificationService.sendAlertNotifications(t,i)}return i}catch(t){throw this.logger.error("Error checking website metrics:",t),t}}async scheduleNextCheck(t){try{let e,r=await this.getMonitoringConfig(t);if(!r||!r.enabled)return null;let a=new Date;switch(r.frequency){case"DAILY":e=(0,h.f)(a,1);break;case"WEEKLY":default:e=(0,u.J)(a,1);break;case"BIWEEKLY":e=(0,u.J)(a,2);break;case"MONTHLY":e=(0,w.P)(a,1);break;case"QUARTERLY":e=(0,w.P)(a,3)}return await d()(async()=>{await y.monitoringConfig.update({where:{websiteId:t},data:{updatedAt:a,nextCheckAt:e}})},m),e}catch(t){throw this.logger.error("Error scheduling next monitoring check:",t),t}}async toggleMonitoring(t,e){try{return await this.getMonitoringConfig(t)?await y.monitoringConfig.update({where:{websiteId:t},data:{enabled:e,updatedAt:new Date}}):await y.monitoringConfig.create({data:{websiteId:t,enabled:e,frequency:"WEEKLY",alertThreshold:10,metrics:["overallScore","seoScore","performanceScore"],emailNotifications:!0,updatedAt:new Date}}),await y.website.update({where:{id:t},data:{monitoringEnabled:e,updatedAt:new Date}}),!0}catch(t){throw this.logger.error("Error toggling monitoring:",t),t}}async updateMonitoringConfig(t,e){try{return await this.getMonitoringConfig(t)?await y.monitoringConfig.update({where:{websiteId:t},data:{...e,updatedAt:new Date}}):await y.monitoringConfig.create({data:{websiteId:t,...e,updatedAt:new Date}}),void 0!==e.enabled&&await y.website.update({where:{id:t},data:{monitoringEnabled:e.enabled,updatedAt:new Date}}),!0}catch(t){return this.logger.error("Error updating monitoring config:",t),!1}}async getMonitoringConfig(t){try{let e=await c.getConfig(t);if(e)return e;let r=await d()(async()=>await y.monitoringConfig.findFirst({where:{websiteId:t}}),m);return r&&await c.setConfig(t,r),r}catch(t){return this.logger.error("Error getting monitoring config:",t),null}}async getAlertsFromCacheOrDatabase(t,e=1,r=10,a=!1){try{let i=(e-1)*r,n=await c.getAlerts(t,{limit:r,offset:i,unreadOnly:a});if(n&&n.length>0)return n;let o=await d()(async()=>await y.alert.findMany({where:{websiteId:t,...a?{read:!1}:{}},orderBy:{createdAt:"desc"},skip:i,take:r}),m);return await c.setAlerts(t,o,{limit:r,offset:i,unreadOnly:a}),o}catch(t){throw this.logger.error("Error getting alerts:",t),t}}async getAlertsCount(t,e=!1){try{let r=await c.getAlertsCount(t,e);if(null!==r)return r;let a=await d()(async()=>await y.alert.count({where:{websiteId:t,...e?{read:!1}:{}}}),m);return await c.setAlertsCount(t,a,e),a}catch(t){return this.logger.error("Error counting alerts:",t),0}}async markAlertsAsRead(t,e){try{return await d()(async()=>{await y.alert.updateMany({where:{id:{in:e},websiteId:t},data:{read:!0,updatedAt:new Date}})},m),await c.invalidateAlertsCache(t),!0}catch(t){return this.logger.error("Error marking alerts as read:",t),!1}}async createAlert(t,e){try{let r=await d()(async()=>await y.alert.create({data:{id:(0,l.A)(),websiteId:t,title:e.title||e.message.substring(0,100),message:e.message,severity:e.severity,category:e.category||e.type||"GENERAL",url:e.url||null,read:!1,createdAt:e.timestamp||new Date,updatedAt:new Date}}),m);return await c.invalidateAlertsCache(t),r}catch(t){throw this.logger.error("Error creating alert:",t),t}}getSeverityForScoreDrop(t){return t>=30?"CRITICAL":t>=20?"ERROR":t>=10?"WARNING":"INFO"}getSeverityForLowScore(t){return t<30?"CRITICAL":t<40?"ERROR":t<50?"WARNING":"INFO"}async deleteAlerts(t,e){try{let r=await d()(async()=>await y.alert.deleteMany({where:{websiteId:t,...e?{createdAt:{lt:e}}:{}}}),m);return await c.invalidateAlertsCache(t),r.count}catch(t){return this.logger.error("Error deleting alerts:",t),0}}async getUnreadAlerts(t){return this.getAlertsFromCacheOrDatabase(t,1,100,!0)}async markAllAlertsAsRead(t){try{return await d()(async()=>{await y.alert.updateMany({where:{websiteId:t,read:!1},data:{read:!0,updatedAt:new Date}})},m),await c.invalidateAlertsCache(t),!0}catch(t){return this.logger.error("Error marking all alerts as read:",t),!1}}async runScheduledChecks(){try{let t=new Date,e=await d()(async()=>await y.monitoringConfig.findMany({where:{enabled:!0,nextCheckAt:{lte:t}},include:{website:!0}}),m),r=0;for(let t of e)try{let e=await this.checkWebsiteMetrics(t.websiteId);await this.scheduleNextCheck(t.websiteId),r++,this.logger.info(`Completed monitoring check for website ${t.websiteId}, found ${e.length} alerts`)}catch(e){this.logger.error(`Error running check for website ${t.websiteId}:`,e)}return r}catch(t){return this.logger.error("Error running scheduled checks:",t),0}}}}};