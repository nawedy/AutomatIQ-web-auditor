"use strict";exports.id=9130,exports.ids=[9130],exports.modules={59130:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{d:()=>d});var a=r(23870),n=r(24263),s=r(59841),o=r(64272),l=r(86370),u=r(73854),c=r(68043),g=e([n]);n=(g.then?(await g)():g)[0];class d{constructor(){this.crawler=new n.J,this.seoAnalyzer=new s.G,this.performanceAnalyzer=new o.F,this.accessibilityAnalyzer=new l.n}async startAudit(e,t,r){let i=(0,a.A)();try{await (0,c.Ay)();let a=n.J.normalizeUrl(e);if(!n.J.isValidUrl(a))throw Error("Invalid URL provided");return await u.sz.create({id:i,url:a,status:"pending",currentStep:"Initializing audit",progress:0}),this.processAudit(i,a,t,r).catch(e=>{console.error(`Audit ${i} failed:`,e),this.updateProgress(i,"failed","Audit failed",0)}),i}catch(e){throw console.error("Failed to start audit:",e),Error("Failed to start audit: "+(e instanceof Error?e.message:"Unknown error"))}}async processAudit(e,t,r,i){let a=Date.now(),n=null;try{await this.crawler.init(),await this.updateProgress(e,"crawling","Crawling website",10);let s=Date.now();n=await this.crawler.crawl(t);let o=Date.now()-s;n.errors.length>0&&console.warn(`Crawl completed with ${n.errors.length} errors for ${t}`),await this.updateProgress(e,"analyzing","Analyzing website",30);let l=Date.now(),g={id:e,url:t,timestamp:new Date,status:"completed",crawlDuration:o,analysisDuration:0,totalDuration:0,userId:i,userAgent:"AutomatIQ-Auditor/1.0",screenshotPath:n.screenshots.desktop,rawData:{crawlResults:n}},d=0;if(Object.entries(r).filter(([e,t])=>t).length,r.seo){await this.updateProgress(e,"analyzing","Analyzing SEO",40);try{g.seo=await this.seoAnalyzer.analyze(n,t),d++}catch(e){console.error("SEO analysis failed:",e),g.seo={score:0,issues:[{type:"error",category:"meta",message:"SEO analysis failed"}],suggestions:["Unable to complete SEO analysis"],metrics:{metaTags:{title:null,description:null,keywords:null},headings:{h1:0,h2:0,h3:0,h4:0,h5:0,h6:0},images:{total:0,missingAlt:0,optimized:0},links:{internal:0,external:0,broken:0}}}}}if(r.performance){await this.updateProgress(e,"analyzing","Analyzing performance",60);try{let{page:e}=await this.crawler.crawlForPerformance(t);g.performance=await this.performanceAnalyzer.analyze(e,t),g.rawData.lighthouseReport=g.performance,await e.close(),d++}catch(e){console.error("Performance analysis failed:",e),g.performance={score:0,suggestions:["Unable to complete performance analysis"],metrics:{lcp:0,fid:0,cls:0,fcp:0,tti:0,tbt:0,si:0},opportunities:[],diagnostics:[]}}}if(r.accessibility){await this.updateProgress(e,"analyzing","Analyzing accessibility",80);try{let{page:e}=await this.crawler.crawlForPerformance(t);g.accessibility=await this.accessibilityAnalyzer.analyze(e),g.rawData.axeResults=g.accessibility,await e.close(),d++}catch(e){console.error("Accessibility analysis failed:",e),g.accessibility={score:0,issues:[{id:"analysis-error",impact:"critical",tags:["error"],description:"Accessibility analysis failed",help:"Please try again",helpUrl:"",nodes:[]}],suggestions:["Unable to complete accessibility analysis"],metrics:{violations:1,incomplete:0,passes:0,inapplicable:0}}}}if(r.mobile){await this.updateProgress(e,"analyzing","Analyzing mobile UX",85);try{g.mobile=await this.analyzeMobileUX(n),d++}catch(e){console.error("Mobile analysis failed:",e),g.mobile={score:0,issues:["Mobile analysis failed"],suggestions:["Unable to complete mobile analysis"],metrics:{viewport:{configured:!1,width:null},touchTargets:{total:0,tooSmall:0,tooClose:0},readability:{fontSizeOk:!1,lineHeightOk:!1},images:{responsive:0,total:0}}}}}if(r.content){await this.updateProgress(e,"analyzing","Analyzing content",90);try{g.content=await this.analyzeContent(n),d++}catch(e){console.error("Content analysis failed:",e),g.content={score:0,issues:["Content analysis failed"],suggestions:["Unable to complete content analysis"],metrics:{readability:{fleschKincaid:0,gunningFog:0,averageSentenceLength:0,averageWordsPerSentence:0},sentiment:{score:0,magnitude:0,overall:"neutral"},structure:{wordCount:0,paragraphs:0,sentences:0,headings:0}}}}}let m=Object.values(g).filter(e=>e&&"object"==typeof e&&"score"in e).map(e=>e.score);g.overallScore=m.length>0?Math.round(m.reduce((e,t)=>e+t,0)/m.length):0;let p=Date.now()-l,h=Date.now()-a;g.analysisDuration=p,g.totalDuration=h,await (0,c.Ay)(),await u.jy.create(g),await this.updateProgress(e,"completed","Audit completed",100),console.log(`✅ Audit ${e} completed in ${h}ms`)}catch(t){throw console.error(`❌ Audit ${e} failed:`,t),await this.updateProgress(e,"failed",`Audit failed: ${t instanceof Error?t.message:"Unknown error"}`,0),t}finally{await this.crawler.close()}}async getAuditProgress(e){try{return await (0,c.Ay)(),await u.sz.findOne({id:e}).lean()}catch(e){return console.error("Failed to get audit progress:",e),null}}async getAuditResults(e){try{return await (0,c.Ay)(),await u.jy.findOne({id:e}).lean()}catch(e){return console.error("Failed to get audit results:",e),null}}async updateProgress(e,t,r,i){try{await (0,c.Ay)(),await u.sz.findOneAndUpdate({id:e},{status:t,currentStep:r,progress:i,updatedAt:new Date})}catch(e){console.error("Failed to update progress:",e)}}async analyzeMobileUX(e){let t=r(51855).parse(e.html),i=t.querySelector('meta[name="viewport"]'),a={configured:!!i,width:i?.getAttribute("content")||null},n={total:t.querySelectorAll('button, a, input[type="button"], input[type="submit"]').length,tooSmall:0,tooClose:0},s=t.querySelectorAll("img"),o={responsive:s.filter(e=>e.getAttribute("srcset")||e.getAttribute("sizes")).length,total:s.length},l=100;return a.configured||(l-=20),o.responsive<.5*o.total&&(l-=10),{score:Math.max(0,l),issues:a.configured?[]:["Missing viewport meta tag"],suggestions:a.configured?["Great mobile setup! Consider testing on various devices"]:["Add viewport meta tag for proper mobile rendering"],metrics:{viewport:a,touchTargets:n,readability:{fontSizeOk:!0,lineHeightOk:!0},images:o}}}async analyzeContent(e){let t=r(51855).parse(e.html),i=t.text||"",a=i.split(/\s+/).filter(e=>e.length>0),n=i.split(/[.!?]+/).filter(e=>e.trim().length>0),s=t.querySelectorAll("p").length,o=t.querySelectorAll("h1, h2, h3, h4, h5, h6").length,l=n.length>0?a.length/n.length:0,u=n.length>0?n.reduce((e,t)=>e+t.length,0)/n.length:0,c=l>0?Math.max(0,206.835-1.015*l-84.6*(u/a.length)):0,g={fleschKincaid:Math.round(c),gunningFog:Math.round(.4*(l+100*(a.filter(e=>e.length>6).length/a.length))),averageSentenceLength:Math.round(u),averageWordsPerSentence:Math.round(l)},d=["good","great","excellent","amazing","wonderful","fantastic"].reduce((e,t)=>e+(i.toLowerCase().match(RegExp(t,"g"))||[]).length,0),m=["bad","terrible","awful","horrible","worst","hate"].reduce((e,t)=>e+(i.toLowerCase().match(RegExp(t,"g"))||[]).length,0),p=d-m,h={wordCount:a.length,paragraphs:s,sentences:n.length,headings:o},y=100;a.length<300&&(y-=20),g.fleschKincaid<30&&(y-=15),0===o&&(y-=10),s<3&&(y-=10);let b=[],w=[];return a.length<300&&(b.push("Content appears to be too short"),w.push("Consider adding more comprehensive content")),g.fleschKincaid<30&&(b.push("Content may be difficult to read"),w.push("Simplify language and sentence structure for better readability")),{score:Math.max(0,y),issues:b,suggestions:w.length>0?w:["Content analysis looks good! Consider regular content updates"],metrics:{readability:g,sentiment:{score:p,magnitude:Math.abs(p),overall:p>0?"positive":p<0?"negative":"neutral"},structure:h}}}}i()}catch(e){i(e)}})},68043:(e,t,r)=>{r.d(t,{Ay:()=>o});var i=r(56037),a=r.n(i);let n=process.env.MONGODB_URI||"mongodb://localhost:27017/automatiq-auditor";if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let o=async function(){if(s.conn)return s.conn;s.promise||(s.promise=a().connect(n,{bufferCommands:!1,maxPoolSize:10,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3,family:4}).then(e=>(console.log("✅ Connected to MongoDB"),e)).catch(e=>{throw console.error("❌ MongoDB connection error:",e),e}));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},73854:(e,t,r)=>{r.d(t,{jy:()=>l,sz:()=>u});var i=r(56037),a=r.n(i);let n=new i.Schema({id:{type:String,required:!0,unique:!0},url:{type:String,required:!0},timestamp:{type:Date,default:Date.now},overallScore:{type:Number,required:!0},status:{type:String,enum:["completed","failed","partial"],required:!0},seo:{score:Number,issues:[{type:{type:String,enum:["error","warning","info"]},category:{type:String,enum:["meta","headings","images","links","structure"]},message:String,element:String,url:String}],suggestions:[String],metrics:{metaTags:{title:String,description:String,keywords:String},headings:{h1:Number,h2:Number,h3:Number,h4:Number,h5:Number,h6:Number},images:{total:Number,missingAlt:Number,optimized:Number},links:{internal:Number,external:Number,broken:Number}}},performance:{score:Number,suggestions:[String],metrics:{lcp:Number,fid:Number,cls:Number,fcp:Number,tti:Number,tbt:Number,si:Number},opportunities:[{id:String,title:String,description:String,savings:Number,wastedBytes:Number,wastedMs:Number}],diagnostics:[{id:String,title:String,description:String,score:Number,scoreDisplayMode:{type:String,enum:["binary","numeric","informative"]}}]},accessibility:{score:Number,issues:[{id:String,impact:{type:String,enum:["minor","moderate","serious","critical"]},tags:[String],description:String,help:String,helpUrl:String,nodes:[{html:String,target:[String],failureSummary:String}]}],suggestions:[String],metrics:{violations:Number,incomplete:Number,passes:Number,inapplicable:Number}},security:{score:Number,issues:[{type:{type:String,enum:["ssl","headers","content","network"]},severity:{type:String,enum:["low","medium","high","critical"]},title:String,description:String,recommendation:String}],suggestions:[String],metrics:{ssl:{valid:Boolean,issuer:String,expires:Date,algorithm:String},headers:i.Schema.Types.Mixed,vulnerabilities:Number}},mobile:{score:Number,issues:[String],suggestions:[String],metrics:{viewport:{configured:Boolean,width:String},touchTargets:{total:Number,tooSmall:Number,tooClose:Number},readability:{fontSizeOk:Boolean,lineHeightOk:Boolean},images:{responsive:Number,total:Number}}},content:{score:Number,issues:[String],suggestions:[String],metrics:{readability:{fleschKincaid:Number,gunningFog:Number,averageSentenceLength:Number,averageWordsPerSentence:Number},sentiment:{score:Number,magnitude:Number,overall:{type:String,enum:["positive","neutral","negative"]}},structure:{wordCount:Number,paragraphs:Number,sentences:Number,headings:Number}}},crawlDuration:{type:Number,required:!0},analysisDuration:{type:Number,required:!0},totalDuration:{type:Number,required:!0},userId:String,userAgent:{type:String,required:!0},screenshotPath:String,rawData:{lighthouseReport:i.Schema.Types.Mixed,axeResults:i.Schema.Types.Mixed,crawlResults:i.Schema.Types.Mixed}},{timestamps:!0,collection:"audit_results"}),s=new i.Schema({id:{type:String,required:!0,unique:!0},url:{type:String,required:!0},status:{type:String,enum:["pending","crawling","analyzing","completed","failed"],default:"pending"},currentStep:{type:String,required:!0},progress:{type:Number,default:0,min:0,max:100},estimatedCompletion:Date},{timestamps:!0,collection:"audit_progress"}),o=new i.Schema({id:{type:String,required:!0,unique:!0},url:{type:String,required:!0},options:{seo:{type:Boolean,default:!0},performance:{type:Boolean,default:!0},accessibility:{type:Boolean,default:!0},security:{type:Boolean,default:!1},mobile:{type:Boolean,default:!0},content:{type:Boolean,default:!1}},priority:{type:Number,default:1,min:1,max:10},status:{type:String,enum:["queued","processing","completed","failed"],default:"queued"},startedAt:Date,completedAt:Date,retryCount:{type:Number,default:0},maxRetries:{type:Number,default:3},errorMessage:String,userId:String},{timestamps:!0,collection:"audit_job_queue"});n.index({url:1,timestamp:-1}),n.index({userId:1,timestamp:-1}),n.index({overallScore:-1}),s.index({id:1}),s.index({status:1,updatedAt:-1}),o.index({status:1,priority:-1,createdAt:1}),o.index({userId:1,createdAt:-1});let l=a().models.AuditResults||a().model("AuditResults",n),u=a().models.AuditProgress||a().model("AuditProgress",s);a().models.AuditJobQueue||a().model("AuditJobQueue",o)}};